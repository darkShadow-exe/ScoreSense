<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ stats.student.name }} - Detailed Stats | ScoreSense</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles_m3.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
</head>
<body>
    <nav>
        <div class="nav-container">
            <h1 class="logo">
                <span class="material-symbols-outlined">analytics</span>
                ScoreSense
            </h1>
            <div class="nav-menu">
                <a href="{{ url_for('index') }}">
                    <span class="material-symbols-outlined">home</span>
                    Home
                </a>
                <a href="{{ url_for('students') }}" class="active">
                    <span class="material-symbols-outlined">group</span>
                    Students
                </a>
                <a href="{{ url_for('stats') }}">
                    <span class="material-symbols-outlined">query_stats</span>
                    Stats
                </a>
                <a href="{{ url_for('command') }}">
                    <span class="material-symbols-outlined">psychology</span>
                    AI Commands
                </a>
            </div>
            <button class="theme-toggle" onclick="toggleDarkMode()" aria-label="Toggle dark mode">
                <span class="material-symbols-outlined">dark_mode</span>
            </button>
        </div>
    </nav>

    <main class="container">
        <!-- Student Header -->
        <div class="student-header" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <a href="{{ url_for('students') }}" class="btn btn-secondary">
                    <span class="material-symbols-outlined">arrow_back</span>
                    Back to Students
                </a>
                <a href="{{ url_for('edit', student_id=stats.student.id) }}" class="btn btn-primary">
                    <span class="material-symbols-outlined">edit</span>
                    Edit Student
                </a>
            </div>
            <h2 style="margin: 0; font-size: 2rem;">
                <span class="material-symbols-outlined" style="font-size: 2rem; vertical-align: middle;">person</span>
                {{ stats.student.name }}
            </h2>
        </div>

        <!-- Overall Statistics -->
        {% if stats.overall_stats %}
        <div class="card" style="margin-bottom: 2rem;">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-symbols-outlined">assessment</span>
                Overall Performance
            </h3>
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem;">
                <div class="stat-item">
                    <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: var(--md-sys-color-primary);">
                        {{ "%.1f"|format(stats.overall_stats.average) }}%
                    </div>
                    <div class="stat-label" style="color: var(--md-sys-color-on-surface-variant);">Average Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: var(--md-sys-color-tertiary);">
                        {{ "%.1f"|format(stats.overall_stats.highest) }}%
                    </div>
                    <div class="stat-label" style="color: var(--md-sys-color-on-surface-variant);">Highest Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: var(--md-sys-color-error);">
                        {{ "%.1f"|format(stats.overall_stats.lowest) }}%
                    </div>
                    <div class="stat-label" style="color: var(--md-sys-color-on-surface-variant);">Lowest Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: var(--md-sys-color-secondary);">
                        {{ stats.overall_stats.total_exams }}
                    </div>
                    <div class="stat-label" style="color: var(--md-sys-color-on-surface-variant);">Total Exams</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: var(--md-sys-color-primary);">
                        {{ stats.overall_stats.subjects_count }}
                    </div>
                    <div class="stat-label" style="color: var(--md-sys-color-on-surface-variant);">Subjects</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Exams Grouped by Exam Name -->
        <div class="card" style="margin-bottom: 2rem;">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-symbols-outlined">school</span>
                Exam History
            </h3>
            
            {% if stats.exams_by_name %}
                {% for exam_name, exam_data in stats.exams_by_name.items() %}
                <div class="exam-group" style="margin-bottom: 2rem; padding: 1.5rem; background: var(--md-sys-color-surface-variant); border-radius: 16px; border-left: 4px solid var(--md-sys-color-primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; font-size: 1.25rem;">{{ exam_name }}</h4>
                        <span style="color: var(--md-sys-color-on-surface-variant); font-size: 0.9rem;">
                            <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle;">calendar_today</span>
                            {{ exam_data.date.split()[0] }}
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                        {% for subject_data in exam_data.subjects %}
                        <div class="subject-score-card" style="padding: 1rem; background: var(--md-sys-color-surface); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; text-transform: capitalize;">{{ subject_data.subject }}</span>
                            <span style="font-size: 1.5rem; font-weight: 700; color: var(--md-sys-color-primary);">{{ subject_data.score }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--md-sys-color-outline-variant);">
                        <span style="font-weight: 500;">Average: </span>
                        <span style="font-size: 1.25rem; font-weight: 700; color: var(--md-sys-color-tertiary);">
                            {{ "%.1f"|format(exam_data.subjects|map(attribute='score')|sum / exam_data.subjects|length) }}%
                        </span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <span class="material-symbols-outlined">folder_open</span>
                    <h3>No Exam History</h3>
                    <p>No exams have been recorded for this student yet.</p>
                </div>
            {% endif %}
        </div>

        <!-- Subject-wise Performance -->
        {% if stats.subject_stats %}
        <div class="card" style="margin-bottom: 2rem;">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-symbols-outlined">subject</span>
                Subject-wise Performance
            </h3>
            
            <div style="display: grid; gap: 1.5rem;">
                {% for subject, data in stats.subject_stats.items() %}
                <div class="subject-detail" style="padding: 1.5rem; background: var(--md-sys-color-surface-variant); border-radius: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; text-transform: capitalize; font-size: 1.25rem;">{{ subject }}</h4>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            {% if data.trend == 'improving' %}
                                <span class="material-symbols-outlined" style="color: var(--md-sys-color-tertiary);">trending_up</span>
                                <span style="color: var(--md-sys-color-tertiary); font-weight: 500;">Improving</span>
                            {% elif data.trend == 'declining' %}
                                <span class="material-symbols-outlined" style="color: var(--md-sys-color-error);">trending_down</span>
                                <span style="color: var(--md-sys-color-error); font-weight: 500;">Declining</span>
                            {% else %}
                                <span class="material-symbols-outlined" style="color: var(--md-sys-color-secondary);">trending_flat</span>
                                <span style="color: var(--md-sys-color-secondary); font-weight: 500;">Stable</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.85rem; color: var(--md-sys-color-on-surface-variant);">Average</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--md-sys-color-primary);">{{ "%.1f"|format(data.average) }}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--md-sys-color-on-surface-variant);">Highest</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--md-sys-color-tertiary);">{{ "%.1f"|format(data.highest) }}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--md-sys-color-on-surface-variant);">Lowest</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--md-sys-color-error);">{{ "%.1f"|format(data.lowest) }}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--md-sys-color-on-surface-variant);">Latest</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--md-sys-color-secondary);">{{ "%.1f"|format(data.latest) }}%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--md-sys-color-on-surface-variant);">Exams Taken</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">{{ data.exam_count }}</div>
                        </div>
                    </div>
                    
                    <!-- Progress bar -->
                    <div class="progress-bar" style="margin-top: 0.5rem;">
                        <div class="progress-fill" style="width: {{ data.average }}%;"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Performance Graphs -->
        <div class="card">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-symbols-outlined">insert_chart</span>
                Performance Graphs
            </h3>
            
            <div class="graph-buttons">
                <button class="btn btn-primary" onclick="loadGraph('{{ stats.student.name }}', 'bar')">
                    <span class="material-symbols-outlined">bar_chart</span>
                    Bar Chart
                </button>
                <button class="btn btn-primary" onclick="loadGraph('{{ stats.student.name }}', 'line')">
                    <span class="material-symbols-outlined">show_chart</span>
                    Line Chart
                </button>
                <button class="btn btn-primary" onclick="loadGraph('{{ stats.student.name }}', 'pie')">
                    <span class="material-symbols-outlined">pie_chart</span>
                    Pie Chart
                </button>
                <button class="btn btn-primary" onclick="loadGraph('{{ stats.student.name }}', 'radar')">
                    <span class="material-symbols-outlined">radar</span>
                    Radar Chart
                </button>
            </div>
            
            <div class="graph-container" id="graphContainer">
                <div style="text-align: center; padding: 3rem; color: var(--md-sys-color-on-surface-variant);">
                    <span class="material-symbols-outlined" style="font-size: 4rem; opacity: 0.5;">insert_chart</span>
                    <p>Select a chart type to visualize performance</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 ScoreSense. Intelligent student performance tracking.</p>
    </footer>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
